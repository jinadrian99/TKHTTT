-------------------------------------------------------------------------------------------------
-- Cập nhật: 16/12/2018
-------------------------------------------------------------------------------------------------
-- Tạo cơ sở dữ liệu KDHH_DW gồm các bảng DIMENSIONS:                                         --
--                                                                                             --
-- KHU_VUC(khoakv, tentpho, tenmien, tenqgia, mavung)                                          --
-- KHACH_HANG(khoakh, makh, tenkh, gioitinh, luatuoi, khoakv)                                  --
-- CUA_HANG(khoach, mach, tench, khoakv)                                                       --
-- THOI_GIAN(khoatg, ngay, thang, quy, nam)                                                    --
-- HANG_HOA(khoahh, mahh, tenhh, loaihh)                                                       --
--                                                                                             --
-- Và FACT TABLE:                                                                              --
-- HOA_DON(sohd, khoach, khoakh, ngayhd, ngaygh, cthd, khoahh, soluong, dongia, thanhtien)     --
--                                                                                             --
-------------------------------------------------------------------------------------------------
-- Tạo cơ sở dữ liệu
IF EXISTS (SELECT * FROM sys.databases WHERE name = 'KDHH_DW')
BEGIN
	USE master
	DROP DATABASE KDHH_DW
END
GO

CREATE DATABASE KDHH_DW
GO

USE KDHH_DW
GO

-----------------------------------------------------------------------------------------------
-- Tạo các bảng tham chiếu cho DIMENSIONS
-----------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------------------
-- Bảng KHU_VUC(khoakv, tentpho, tenmien, tenqgia, mavung)

CREATE TABLE KHU_VUC
(
	khoakv	NUMERIC(5) PRIMARY KEY,
	tentpho	NVARCHAR(30),
	tenmien	NVARCHAR(30),
	tenqgia	NVARCHAR(30),
	mavung  CHAR(5)
)
GO

INSERT INTO KHU_VUC VALUES(10001, N'TPHCM'      , N'Miền Nam'     , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10002, N'Cần Thơ'    , N'Miền Nam'     , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10003, N'Đồng Nai'   , N'Miền Nam'     , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10004, N'Bình Dương' , N'Miền Nam'     , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10005, N'Hà Nội'     , N'Miền Bắc'     , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10006, N'Hải Phòng'  , N'Miền Bắc'     , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10007, N'Nam Định'   , N'Miền Bắc'     , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10008, N'Đà Nẵng'    , N'Miền Trung'   , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10009, N'Huế'        , N'Miền Trung'   , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10010, N'Quảng Ngãi' , N'Miền Trung'   , N'Việt Nam', NULL)
INSERT INTO KHU_VUC VALUES(10011, N'Oxford'     , N'OHio'         , N'Hoa Kỳ'  , NULL)
INSERT INTO KHU_VUC VALUES(10012, N'Baton Rouge', N'Louisiana'    , N'Hoa Kỳ'  , NULL)
INSERT INTO KHU_VUC VALUES(10013, N'Milwaukee'  , N'Wisconsin'    , N'Hoa Kỳ'  , NULL)
INSERT INTO KHU_VUC VALUES(10014, N'San Jose'   , N'California'   , N'Hoa Kỳ'  , NULL)
INSERT INTO KHU_VUC VALUES(10015, N'Oxford'     , N'Mississippi'  , N'Hoa Kỳ'  , NULL)
INSERT INTO KHU_VUC VALUES(10016, N'Oxford'     , N'Massachusetts', N'Hoa Kỳ'  , NULL)


-----------------------------------------------------------------------------------------------
-- Bảng KHACH_HANG(khoakh, makh, tenkh, gioitinh, luatuoi, khoakv)

CREATE TABLE KHACH_HANG
(
	khoakh		NUMERIC(5) PRIMARY KEY,	
	makh		VARCHAR(8)	, 
	tenkh		NVARCHAR(30), 
	gioitinh	VARCHAR(1), 
	luatuoi		VARCHAR(5),
	khoakv		NUMERIC(5),
	FOREIGN KEY (khoakv) REFERENCES KHU_VUC(khoakv)
)

INSERT INTO KHACH_HANG VALUES (20001, 'KH000001', N'Lê Thanh Bình'    , 'M', '25-40', 10001)
INSERT INTO KHACH_HANG VALUES (20002, 'KH000002', N'Nguyễn Cao Cường' , 'M', '41-59', 10002)
INSERT INTO KHACH_HANG VALUES (20003, 'KH000003', N'Phạm Thanh Sơn'   , 'M', '25-40', 10003)
INSERT INTO KHACH_HANG VALUES (20004, 'KH000004', N'Lê Thành Tài'     , 'M', '41-59', 10004)
INSERT INTO KHACH_HANG VALUES (20005, 'KH000005', N'Lê Mỹ Dung'       , 'F', '41-59', 10005)
INSERT INTO KHACH_HANG VALUES (20006, 'KH000006', N'Trần Thanh Tâm'   , 'F', '25-40', 10006)
INSERT INTO KHACH_HANG VALUES (20007, 'KH000007', N'Lê Như Quỳnh'     , 'F', '41-59', 10007)
INSERT INTO KHACH_HANG VALUES (20008, 'KH000008', N'Trần Bình Minh'   , 'M', '25-40', 10008)
INSERT INTO KHACH_HANG VALUES (20009, 'KH000009', N'Phan Ngọc Đức'    , 'M', '41-59', 10009)
INSERT INTO KHACH_HANG VALUES (20010, 'KH000010', N'Nguyễn Cẩm Tú'    , 'F', '41-59', 10010)
INSERT INTO KHACH_HANG VALUES (20011, 'KH000011', N'John F'           , 'M', '25-40', 10011)
INSERT INTO KHACH_HANG VALUES (20012, 'KH000012', N'Katerine.L'       , 'F', '41-59', 10012)
INSERT INTO KHACH_HANG VALUES (20013, 'KH000013', N'Richard.S'        , 'M', '25-40', 10013)
INSERT INTO KHACH_HANG VALUES (20014, 'KH000014', N'Mick.D'           , 'M', '25-40', 10014)
INSERT INTO KHACH_HANG VALUES (20015, 'KH000015', N'Nguyễn Thanh Hằng', 'F', '60+'  , 10001)


-----------------------------------------------------------------------------------------------
-- Bảng CUA_HANG(khoach, mach, tench, khoakv)

CREATE TABLE CUA_HANG
(
	khoach	NUMERIC(5) PRIMARY KEY, 
	mach	VARCHAR(8), 
	tench	NVARCHAR(30), 
	khoakv	NUMERIC(5),
	FOREIGN KEY (khoakv) REFERENCES KHU_VUC(khoakv)
)
GO

INSERT INTO CUA_HANG VALUES (30001, 'CH000001', N'Cửa hàng Q.5'         , 10001)
INSERT INTO CUA_HANG VALUES (30002, 'CH000002', N'Cửa hàng Q.10'        , 10001)
INSERT INTO CUA_HANG VALUES (30003, 'CH000003', N'Cửa hàng Cần Thơ'     , 10002)
INSERT INTO CUA_HANG VALUES (30004, 'CH000004', N'Cửa hàng Long Thành'  , 10003)
INSERT INTO CUA_HANG VALUES (30005, 'CH000005', N'Cửa hàng Thủ Dầu Một' , 10004)
INSERT INTO CUA_HANG VALUES (30006, 'CH000006', N'Cửa hàng Q.Hoàn Kiếm' , 10005)
INSERT INTO CUA_HANG VALUES (30007, 'CH000007', N'Cửa hàng Hải phòng'   , 10006)
INSERT INTO CUA_HANG VALUES (30008, 'CH000008', N'Cửa hàng Nam Định'    , 10007)
INSERT INTO CUA_HANG VALUES (30009, 'CH000009', N'Cửa hàng Đà Nẵng'     , 10008)
INSERT INTO CUA_HANG VALUES (30010, 'CH000010', N'Cửa hàng Huế'         , 10009)
INSERT INTO CUA_HANG VALUES (30011, 'CH000011', N'Royal Blue Grocery'   , 10011)
INSERT INTO CUA_HANG VALUES (30012, 'CH000012', N'Orlando Grocery'      , 10012)
INSERT INTO CUA_HANG VALUES (30013, 'CH000013', N'Foodie Store'         , 10013)
INSERT INTO CUA_HANG VALUES (30014, 'CH000014', N'Rainbow Grocery Store', 10014)


-----------------------------------------------------------------------------------------------
-- Bảng HANG_HOA(khoahh, mahh, tenhh, loaihh)                                                  

CREATE TABLE HANG_HOA
(
	khoahh	NUMERIC(5) PRIMARY KEY,
	mahh	VARCHAR(13), 
	tenhh	NVARCHAR(30),
	loaihh	NVARCHAR(5)
)
GO

INSERT INTO HANG_HOA VALUES (40001, 'HH001', N'Trà xanh O2'      , 'NGK')
INSERT INTO HANG_HOA VALUES (40002, 'HH002', N'Coca cola'        , 'NGK')
INSERT INTO HANG_HOA VALUES (40003, 'HH003', N'Bánh ChocoPie'    , 'BANHK')
INSERT INTO HANG_HOA VALUES (40004, 'HH004', N'Dầu ăn Tường An'  , 'DAUAN')
INSERT INTO HANG_HOA VALUES (40005, 'HH005', N'Bánh AFC'         , 'BANHK')
INSERT INTO HANG_HOA VALUES (40006, 'HH006', N'Dầu ăn Neptune'   , 'DAUAN')
INSERT INTO HANG_HOA VALUES (40007, 'HH007', N'Bia Heineken'     , 'NGK')
INSERT INTO HANG_HOA VALUES (40008, 'HH008', N'Pepsi'            , 'NGK')
INSERT INTO HANG_HOA VALUES (40009, 'HH009', N'Cam ép Twister'   , 'NGK')
INSERT INTO HANG_HOA VALUES (40010, 'HH010', N'Sữa đậu nành Soya', 'NGK')
INSERT INTO HANG_HOA VALUES (40011, 'HH011', N'Bánh Hura'        , 'BANHK')
INSERT INTO HANG_HOA VALUES (40012, 'HH012', N'Bánh Oreo'        , 'BANHK')
INSERT INTO HANG_HOA VALUES (40013, 'HH013', N'Bánh Goute'       , 'BANHK')
INSERT INTO HANG_HOA VALUES (40014, 'HH014', N'Kẹo Alpenliebe'   , 'BANHK')
INSERT INTO HANG_HOA VALUES (40015, 'HH015', N'Kẹo Golia'        , 'BANHK')


-----------------------------------------------------------------------------------------------
-- Bảng THOI_GIAN(khoatg, ngay, thang, quy, nam)
CREATE TABLE THOI_GIAN
(
	khoatg	NUMERIC(8) PRIMARY KEY, 
	ngay	DATE,
	thang	NUMERIC(2), 
	quy	NUMERIC(1), 
	nam	NUMERIC(4)
)
GO

INSERT INTO THOI_GIAN VALUES (20130101, '01-JAN-2013',  1, 1, 2013)
INSERT INTO THOI_GIAN VALUES (20130201, '01-FEB-2013',  2, 1, 2013)
INSERT INTO THOI_GIAN VALUES (20130301, '01-MAR-2013',  3, 1, 2013)
INSERT INTO THOI_GIAN VALUES (20130401, '01-APR-2013',  4, 2, 2013)
INSERT INTO THOI_GIAN VALUES (20130501, '01-MAY-2013',  5, 2, 2013)
INSERT INTO THOI_GIAN VALUES (20130601, '01-JUN-2013',  6, 2, 2013)
INSERT INTO THOI_GIAN VALUES (20130701, '01-JUL-2013',  7, 3, 2013)
INSERT INTO THOI_GIAN VALUES (20130801, '01-AUG-2013',  8, 3, 2013)
INSERT INTO THOI_GIAN VALUES (20130901, '01-SEP-2013',  9, 3, 2013)
INSERT INTO THOI_GIAN VALUES (20131001, '01-OCT-2013', 10, 4, 2013)
INSERT INTO THOI_GIAN VALUES (20131101, '01-NOV-2013', 11, 4, 2013)
INSERT INTO THOI_GIAN VALUES (20131201, '01-DEC-2013', 12, 4, 2013)
INSERT INTO THOI_GIAN VALUES (20140101, '01-JAN-2014',  1, 1, 2014)
INSERT INTO THOI_GIAN VALUES (20140201, '01-FEB-2014',  2, 1, 2014)
INSERT INTO THOI_GIAN VALUES (20140301, '01-MAR-2014',  3, 1, 2014)
INSERT INTO THOI_GIAN VALUES (20140401, '01-APR-2014',  4, 2, 2014)
INSERT INTO THOI_GIAN VALUES (20140501, '01-MAY-2014',  5, 2, 2014)
INSERT INTO THOI_GIAN VALUES (20140601, '01-JUN-2014',  6, 2, 2014)
INSERT INTO THOI_GIAN VALUES (20140701, '01-JUL-2014',  7, 3, 2014)
INSERT INTO THOI_GIAN VALUES (20140801, '01-AUG-2014',  8, 3, 2014)
INSERT INTO THOI_GIAN VALUES (20140901, '01-SEP-2014',  9, 3, 2014)
INSERT INTO THOI_GIAN VALUES (20141001, '01-OCT-2014', 10, 4, 2014)
INSERT INTO THOI_GIAN VALUES (20141101, '01-NOV-2014', 11, 4, 2014)
INSERT INTO THOI_GIAN VALUES (20141201, '01-DEC-2014', 12, 4, 2014)


-----------------------------------------------------------------------------------------------
-- Tạo Fact Table
-----------------------------------------------------------------------------------------------
-- Bảng HOA_DON(sohd, khoach, khoakh, ngayhd, ngaygh, cthd, khoahh, soluong, dongia, thanhtien)

CREATE TABLE HOA_DON
(
	sohd		CHAR(8),
	khoach		NUMERIC(5), 
	khoakh		NUMERIC(5), 
	ngayhd		NUMERIC(8),
	ngaygh		NUMERIC(8),
	cthd		NUMERIC(2), 
	khoahh		NUMERIC(5), 
	soluong		NUMERIC(4),
	dongia		NUMERIC(8),
	thanhtien 	AS soluong*dongia, 
	PRIMARY KEY (sohd, cthd),
	FOREIGN KEY (khoach) REFERENCES CUA_HANG(khoach),
	FOREIGN KEY (khoakh) REFERENCES KHACH_HANG(khoakh),
	FOREIGN KEY (ngayhd) REFERENCES THOI_GIAN(khoatg),
	FOREIGN KEY (ngaygh) REFERENCES THOI_GIAN(khoatg),
	FOREIGN KEY (khoahh) REFERENCES HANG_HOA(khoahh)
)
GO

INSERT INTO HOA_DON VALUES ('HD000001', 30002, 20001, 20130101, 20130101, 1, 40001, 15, 8500)
INSERT INTO HOA_DON VALUES ('HD000002', 30001, 20001, 20130101, 20130101, 1, 40001, 3, 8500)
INSERT INTO HOA_DON VALUES ('HD000003', 30003, 20005, 20130201, 20130201, 1, 40006, 15, 18500)
INSERT INTO HOA_DON VALUES ('HD000004', 30003, 20002, 20130301, 20130301, 1, 40007, 12, 12500)
INSERT INTO HOA_DON VALUES ('HD000005', 30011, 20011, 20130301, 20130301, 1, 40009, 20, 23000)
INSERT INTO HOA_DON VALUES ('HD000006', 30002, 20001, 20130301, 20130301, 1, 40001, 12, 8500)
INSERT INTO HOA_DON VALUES ('HD000007', 30001, 20001, 20130401, 20130401, 1, 40015, 5, 14500)
INSERT INTO HOA_DON VALUES ('HD000008', 30014, 20014, 20130401, 20130401, 1, 40003, 15, 34500)
INSERT INTO HOA_DON VALUES ('HD000009', 30006, 20005, 20130501, 20130501, 1, 40004, 2, 19700)
INSERT INTO HOA_DON VALUES ('HD000010', 30004, 20003, 20130501, 20130501, 1, 40002, 8, 10000)
INSERT INTO HOA_DON VALUES ('HD000011', 30005, 20004, 20130601, 20130601, 1, 40008, 3, 17000)
INSERT INTO HOA_DON VALUES ('HD000012', 30012, 20012, 20130601, 20130601, 1, 40014, 15, 6500)
INSERT INTO HOA_DON VALUES ('HD000013', 30004, 20003, 20130701, 20130701, 1, 40012, 11, 9000)
INSERT INTO HOA_DON VALUES ('HD000014', 30009, 20010, 20130701, 20130701, 1, 40009, 5, 23000)
INSERT INTO HOA_DON VALUES ('HD000015', 30014, 20014, 20130801, 20130801, 1, 40013, 5, 25000)
INSERT INTO HOA_DON VALUES ('HD000016', 30002, 20015, 20130801, 20130801, 1, 40011, 9, 15000)
INSERT INTO HOA_DON VALUES ('HD000017', 30013, 20013, 20130901, 20130901, 1, 40010, 5, 21000)
INSERT INTO HOA_DON VALUES ('HD000018', 30005, 20004, 20131001, 20131001, 1, 40009, 2, 23000)
INSERT INTO HOA_DON VALUES ('HD000019', 30007, 20006, 20131101, 20131101, 1, 40005, 3, 16700)
INSERT INTO HOA_DON VALUES ('HD000020', 30008, 20007, 20131101, 20131101, 1, 40013, 2, 25000)
INSERT INTO HOA_DON VALUES ('HD000021', 30009, 20008, 20131201, 20131201, 1, 40015, 1, 14500)
INSERT INTO HOA_DON VALUES ('HD000022', 30010, 20009, 20131201, 20131201, 1, 40004, 7, 19700)
INSERT INTO HOA_DON VALUES ('HD000023', 30002, 20015, 20131201, 20131201, 1, 40001, 5, 8500)
INSERT INTO HOA_DON VALUES ('HD000024', 30008, 20006, 20131201, 20131201, 1, 40002, 68, 9000)
INSERT INTO HOA_DON VALUES ('HD000025', 30013, 20013, 20131201, 20131201, 1, 40003, 50, 34500)
INSERT INTO HOA_DON VALUES ('HD000026', 30002, 20001, 20140101, 20140101, 1, 40001, 15, 8500)
INSERT INTO HOA_DON VALUES ('HD000027', 30003, 20005, 20140201, 20140201, 1, 40006, 15, 18500)
INSERT INTO HOA_DON VALUES ('HD000028', 30003, 20002, 20140301, 20140301, 1, 40007, 12, 12500)
INSERT INTO HOA_DON VALUES ('HD000029', 30011, 20011, 20140301, 20140301, 1, 40009, 20, 23000)
INSERT INTO HOA_DON VALUES ('HD000030', 30002, 20001, 20140301, 20140301, 1, 40001, 12, 8500)
INSERT INTO HOA_DON VALUES ('HD000031', 30003, 20002, 20140301, 20140301, 1, 40015, 5, 14500)
INSERT INTO HOA_DON VALUES ('HD000032', 30011, 20014, 20140301, 20140301, 1, 40003, 1, 34500)
INSERT INTO HOA_DON VALUES ('HD000033', 30001, 20001, 20140401, 20140401, 1, 40015, 5, 14500)
INSERT INTO HOA_DON VALUES ('HD000034', 30014, 20014, 20140401, 20140401, 1, 40003, 15, 34500)
INSERT INTO HOA_DON VALUES ('HD000035', 30006, 20005, 20140501, 20140501, 1, 40004, 2, 19700)
INSERT INTO HOA_DON VALUES ('HD000036', 30004, 20003, 20140501, 20140501, 1, 40002, 8, 10000)
INSERT INTO HOA_DON VALUES ('HD000037', 30005, 20004, 20140501, 20140501, 1, 40008, 3, 17000)
INSERT INTO HOA_DON VALUES ('HD000038', 30012, 20012, 20140501, 20140501, 1, 40014, 15, 6500)
INSERT INTO HOA_DON VALUES ('HD000039', 30007, 20006, 20140501, 20140501, 1, 40002, 18, 9000)
INSERT INTO HOA_DON VALUES ('HD000040', 30005, 20005, 20140501, 20140501, 1, 40008, 250, 17000)
INSERT INTO HOA_DON VALUES ('HD000041', 30004, 20003, 20140601, 20140601, 1, 40012, 11, 9000)
INSERT INTO HOA_DON VALUES ('HD000042', 30009, 20010, 20140601, 20140601, 1, 40009, 5, 23000)
INSERT INTO HOA_DON VALUES ('HD000043', 30006, 20005, 20140601, 20140601, 1, 40002, 12, 9000)
INSERT INTO HOA_DON VALUES ('HD000044', 30014, 20014, 20140701, 20140701, 1, 40013, 5, 25000)
INSERT INTO HOA_DON VALUES ('HD000045', 30002, 20015, 20140701, 20140701, 1, 40011, 9, 15000)
INSERT INTO HOA_DON VALUES ('HD000046', 30014, 20012, 20140701, 20140701, 1, 40013, 7, 25000)
INSERT INTO HOA_DON VALUES ('HD000047', 30013, 20013, 20140801, 20140801, 1, 40010, 5, 21000)
INSERT INTO HOA_DON VALUES ('HD000048', 30005, 20004, 20140901, 20140901, 1, 40009, 2, 23000)
INSERT INTO HOA_DON VALUES ('HD000049', 30007, 20006, 20141001, 20141001, 1, 40005, 3, 16700)
INSERT INTO HOA_DON VALUES ('HD000050', 30008, 20007, 20141101, 20141101, 1, 40013, 2, 25000)
INSERT INTO HOA_DON VALUES ('HD000051', 30009, 20008, 20141201, 20141201, 1, 40015, 1, 14500)
INSERT INTO HOA_DON VALUES ('HD000052', 30010, 20009, 20141201, 20141201, 1, 40004, 7, 19700)
INSERT INTO HOA_DON VALUES ('HD000053', 30002, 20015, 20141201, 20141201, 1, 40001, 5, 8500)
INSERT INTO HOA_DON VALUES ('HD000054', 30008, 20006, 20141201, 20141201, 1, 40002, 68, 9000)
INSERT INTO HOA_DON VALUES ('HD000055', 30013, 20013, 20141201, 20141201, 1, 40003, 50, 34500)
